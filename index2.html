<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>

<body>
    <div id="map"></div>
    <div id="city-info"></div>
    <script>
        const width = 960, height = 600;
        var count = 0;

        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoAlbersUsa()
            .scale(1280)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath()
            .projection(projection);

        const cityInfo = d3.select("#city-info");

        d3.json("data/maps/us-map.json").then(us => {
            svg.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter()
                .append("path")
                .attr("d", path);

            d3.json("data/maps/us-cities.json").then(async cities => {
                const citiesWithPollutionData = await fetchAndUpdatePollutionData(cities);

                svg.append("g")
                    .attr("class", "cities")
                    .selectAll("circle")
                    .data(citiesWithPollutionData)
                    .enter()
                    .append("circle")
                    .attr("cx", d => projection([d.Longitude, d.Latitude])[0])
                    .attr("cy", d => projection([d.Longitude, d.Latitude])[1])
                    .attr("r", d => Math.sqrt(d.Population) / 100)
                    .attr("fill", d => {
                        const maxAqi = Math.max(...d.pollutionData.map(p => +p.AQI));
                        return getColorFromAQI(maxAqi);
                    })
                    .on("click", (event, d) => showCityInfo(d));
            });


        });

        async function getPollutionData(latitude, longitude) {
            const date = new Date();
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const distance = 25;
            const apiKey = "7B2A235A-4BB4-40C7-A720-3678CE796996";

            const url = `https://www.airnowapi.org/aq/forecast/latLong/?format=text/csv&latitude=${latitude}&longitude=${longitude}&date=${formattedDate}&distance=${distance}&API_KEY=${apiKey}`;

            const response = await fetch(url);
            const data = await response.text();
            const rows = data.split('\n');
            const header = rows.shift().split(',');

            const pollutionData = rows.map(row => {
                const rowData = row.split(',');
                return header.reduce((acc, columnName, index) => {
                    acc[columnName] = rowData[index];
                    return acc;
                }, {});
            });

            return pollutionData;
        }


        async function fetchAndUpdatePollutionData(cities) {
            const pollutionData = localStorage.getItem("pollutionData");
            const pollutionDataTimestamp = localStorage.getItem("pollutionDataTimestamp");

            const currentDate = new Date().setHours(0, 0, 0, 0);

            if (pollutionData && pollutionDataTimestamp && new Date(+pollutionDataTimestamp).setHours(0, 0, 0, 0) === currentDate) {
                return JSON.parse(pollutionData);
            } else {
                const updatedPollutionData = await Promise.all(cities.map(async city => {
                    const pollutionData = await getPollutionData(city.Latitude, city.Longitude);
                    return { ...city, pollutionData };
                }));

                localStorage.setItem("pollutionData", JSON.stringify(updatedPollutionData));
                localStorage.setItem("pollutionDataTimestamp", currentDate);

                return updatedPollutionData;
            }
        }



        function getColorFromAQI(aqi) {
            if (aqi <= 50) return "#00FF00";
            if (aqi <= 100) return "#FFFF00";
            if (aqi <= 150) return "#FFA500";
            if (aqi <= 200) return "#FF0000";
            return "#8B0000";
        }


        function showCityInfo(city) {
            console.log(count)
            cityInfo.html(`
        <h3>${city.AccentCity}, ${city.Region}</h3>
        <p>Population: ${city.Population}</p>
        <p>Latitude: ${city.Latitude}</p>
        <p>Longitude: ${city.Longitude}</p>
        <p>Pollution: <span style="color: ${getPollutionColor(city.Id)}">‚óè</span></p>
    `);
        }


    </script>

    <pre id="stored-pollution-data"></pre>

    <script>
        function showStoredPollutionData() {
            const storedPollutionData = localStorage.getItem("pollutionData");
            const storedPollutionDataTimestamp = localStorage.getItem("pollutionDataTimestamp");

            console.log(storedPollutionData)

            if (storedPollutionData && storedPollutionDataTimestamp) {
                const formattedData = JSON.stringify(JSON.parse(storedPollutionData), null, 2);
                const formattedTimestamp = new Date(+storedPollutionDataTimestamp).toLocaleString();

                document.getElementById("stored-pollution-data").innerText = `Data timestamp: ${formattedTimestamp}\n\n${formattedData}`;
            } else {
                document.getElementById("stored-pollution-data").innerText = "No pollution data found in localStorage.";
            }
        }

        showStoredPollutionData();

    </script>

</body>

</html>